{"version":3,"file":"polpware-ngx-net-crud.js","sources":["ng://@polpware/ngx-net-crud/lib/services/observable-crud.service.ts","ng://@polpware/ngx-net-crud/lib/services/observable-duet-table.service.ts","ng://@polpware/ngx-net-crud/public_api.ts","ng://@polpware/ngx-net-crud/polpware-ngx-net-crud.ts"],"sourcesContent":["import { Injector } from '@angular/core';\nimport { HttpClient, HttpResponse, HttpHeaders, HttpParams, HttpErrorResponse } from '@angular/common/http';\n\nimport { Observable, BehaviorSubject } from 'rxjs';\n\nimport { liftIntoReject } from '@polpware/fe-utilities';\n\nimport { toPromise } from '@polpware/ngx-rxjs';\n\nimport {\n    GlobalEventsService\n} from '@polpware/ngx-events';\n\nimport {\n    ISpinnerService,\n    NullSpinner\n} from '@polpware/ngx-spinner';\n\nimport {\n    IBaseEntity\n} from '@polpware/ngx-model';\n\nexport {\n    IBaseEntity\n} from '@polpware/ngx-model';\n\nexport abstract class ObservableCurdService<T extends IBaseEntity> {\n\n    protected subject: BehaviorSubject<Array<T>>;\n\n    protected http: HttpClient;\n    protected eventsService: GlobalEventsService;\n    protected spinner: ISpinnerService;\n\n    protected withCredentialOnRequest: boolean;\n\n    constructor(injector: Injector) {\n\n        this.withCredentialOnRequest = true;\n\n        this.subject = new BehaviorSubject([]);\n\n        this.http = injector.get(HttpClient);\n        this.eventsService = injector.get(GlobalEventsService);\n\n        this.spinner = new NullSpinner();\n    }\n\n    // *************************************\n    // abstract methods\n    // *************************************\n    protected abstract listUrl(...args: any[]): string;\n    protected abstract deleteUrl(...args: any[]): string;\n    protected abstract createUrl(...args: any[]): string;\n    protected abstract updateUrl(...args: any[]): string;\n\n    protected abstract getListGuard(): boolean;\n    protected abstract deleteByIdGuard(id: string): boolean;\n\n    protected abstract notifyList(data: Array<T>): void;\n    protected abstract notifyDelete(id: string): void;\n    protected abstract notifyCreate(record: T);\n    protected abstract notifyUpdate(record: T);\n\n    abstract getById(id: string): T;\n    abstract getByIdAsync(id: string, mySpinner: ISpinnerService): PromiseLike<T>;\n\n    protected handleError(error: HttpErrorResponse) {\n        this.eventsService.broadcast('http-error', [error]);\n    }\n\n    public onDataChange(): Observable<Array<T>> {\n        return this.subject.asObservable();\n    }\n\n    // Default methods\n    protected parseCreateResponse(record: T, data): T {\n        const id = data;\n        record.id = id;\n        return record;\n    }\n\n    protected parseUpdateResponse(record: T, data): T {\n        return record;\n    }\n\n    protected parseListResponse(data): T[] {\n        return data;\n    }\n\n    // Returns a list of entities\n    protected listRequest(options: { [key: string]: any }): Observable<T[]> {\n        let httpParams = new HttpParams();\n        for (const k in options) {\n            if (options.hasOwnProperty(k)) {\n                httpParams = httpParams.set(k, options[k]);\n            }\n        }\n\n        return this.http.get<T[]>(this.listUrl(), {\n            withCredentials: this.withCredentialOnRequest,\n            params: httpParams\n        });\n    }\n\n    getListAsync(options: { [key: string]: any }, mySpinner: ISpinnerService = null): PromiseLike<any> {\n        // In most cases, we do not need to send out a request\n        // if we already have some data.\n        if (this.getListGuard()) {\n            return liftIntoReject('not allowed');\n        }\n\n        const spinner = mySpinner || this.spinner;\n\n        spinner.show();\n        return toPromise(this.listRequest(options))\n            .then((data) => {\n                spinner.hide();\n\n                const newData = this.parseListResponse(data);\n                this.notifyList(newData);\n\n                return newData;\n            }, (error) => {\n                spinner.hide();\n\n                this.handleError(error);\n\n                return error;\n            });\n    }\n\n    // Use post instead of delete method to implement delelete ??\n    protected deleteByIdRequest(id: string): Observable<{}> {\n        return this.http.delete(this.deleteUrl(id), {\n            withCredentials: this.withCredentialOnRequest\n        });\n    }\n\n    deleteByIdAsync(id: string, mySpinner: ISpinnerService = null): PromiseLike<any> {\n\n        if (this.deleteByIdGuard(id)) {\n            return liftIntoReject('not allowed');\n        }\n\n        const spinner = mySpinner || this.spinner;\n        spinner.show();\n        return toPromise(this.deleteByIdRequest(id))\n            .then((x) => {\n                spinner.hide();\n\n                this.notifyDelete(id);\n                return id;\n            }, (error) => {\n                spinner.hide();\n\n                this.handleError(error);\n\n                return error;\n            });\n    }\n\n\n    protected adaptorCreateInput(record: T): Object {\n        return record;\n    }\n\n    protected createRequest(record: T): Observable<T> {\n        const body = {};\n        const tyRecord = this.adaptorCreateInput(record);\n        for (const prop in tyRecord) {\n            if (tyRecord.hasOwnProperty(prop)) {\n                body[prop] = tyRecord[prop];\n            }\n        }\n        return this.http.post<T>(this.createUrl(), body, {\n            withCredentials: this.withCredentialOnRequest\n        });\n    }\n\n    createAsync(record: T, mySpinner: ISpinnerService = null): PromiseLike<any> {\n\n        const spinner = mySpinner || this.spinner;\n        spinner.show();\n        return toPromise(this.createRequest(record))\n            .then((x) => {\n                spinner.hide();\n\n                // Side effects\n                record = this.parseCreateResponse(record, x);\n                this.notifyCreate(record);\n\n                return record;\n            }, (error) => {\n                spinner.hide();\n\n                this.handleError(error);\n\n                return error;\n            });\n    }\n\n    protected adaptorUpdateInput(record: T): Object {\n        return record;\n    }\n\n    protected updateRequest(record: T): Observable<T> {\n        const body = {};\n        const tyRecord = this.adaptorUpdateInput(record);\n        for (const prop in tyRecord) {\n            if (tyRecord.hasOwnProperty(prop)) {\n                body[prop] = tyRecord[prop];\n            }\n        }\n\n        return this.http.put<T>(this.updateUrl(record.id), body, {\n            withCredentials: this.withCredentialOnRequest\n        });\n    }\n\n    updateAsync(record: T, mySpinner: ISpinnerService = null): PromiseLike<any> {\n\n        const spinner = mySpinner || this.spinner;\n        spinner.show();\n        return toPromise(this.updateRequest(record))\n            .then((x) => {\n                spinner.hide();\n\n                // Side effects\n                record = this.parseUpdateResponse(record, x);\n                this.notifyUpdate(record);\n\n                return record;\n            }, (error) => {\n                spinner.hide();\n\n                // TODO: error handling\n                this.handleError(error);\n\n                return error;\n            });\n    }\n\n}\n","import { Injector } from '@angular/core';\n\nimport { IRelationalTable } from '@polpware/fe-data';\n\nimport { lift } from '@polpware/fe-utilities';\n\nimport {\n    ISpinnerService\n} from '@polpware/ngx-spinner';\n\nimport {\n    ObservableCurdService,\n    IBaseEntity\n} from './observable-crud.service';\n\nexport {\n    IBaseEntity\n} from './observable-crud.service';\n\nexport abstract class ObservableDuetTableService<T extends IBaseEntity>\n    extends ObservableCurdService<T> {\n\n    protected primaryTable: IRelationalTable;\n    protected secondaryTable: IRelationalTable;\n\n    constructor(injector: Injector) {\n        super(injector);\n    }\n\n    private buildPublishData() {\n        const models = this.primaryTable.dataProvider().models as Array<any>;\n        const data = models.map((x) => x.attributes as T);\n        return data;\n    }\n\n    protected listenToPrimaryTable() {\n        this.primaryTable.dataProvider().on('update', () => {\n            console.log('Received pimary table updates');\n            const data = this.buildPublishData();\n            this.subject.next(data);\n        });\n    }\n\n    protected publishInitData() {\n        const data = this.buildPublishData();\n        this.subject.next(data);\n    }\n\n    // Override\n    protected getListGuard(): boolean {\n        return false;\n    }\n\n    // Implement\n    getById(id: string): T {\n        const model = this.primaryTable.get(id);\n        if (model) {\n            return model.attributes as T;\n        }\n        return null;\n    }\n\n    getByIdAsync(id: string, mySpinner: ISpinnerService = null): PromiseLike<T> {\n        throw new Error('Not implemented');\n    }\n\n    // Override\n    protected deleteByIdGuard(id: string) {\n        return false;\n    }\n\n    // Override\n    protected notifyDelete(id: string) {\n        // Side effects\n        const model = this.primaryTable.get(id);\n        if (model) {\n            model.destroyFromTable();\n        }\n    }\n\n    // Override\n    protected notifyCreate(record: T) {\n        this.primaryTable.add(record);\n    }\n\n    protected notifyUpdate(record: T) {\n        // The following op basically update what we have ...\n        this.primaryTable.add(record);\n    }\n}\n","/*\n * Public API Surface of ngx-net-crud\n */\n\nexport * from './lib/services/observable-crud.service';\nexport * from './lib/services/observable-duet-table.service';\n\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public_api';\n"],"names":[],"mappings":"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"}