import { HttpClient, HttpParams } from '@angular/common/http';
import { BehaviorSubject } from 'rxjs';
import { liftIntoReject } from '@polpware/fe-utilities';
import { toPromise } from '@polpware/ngx-rxjs';
import { GlobalEventsService } from '@polpware/ngx-events';
import { NullSpinner } from '@polpware/ngx-spinner';
var ObservableCurdService = /** @class */ (function () {
    function ObservableCurdService(injector) {
        this.withCredentialOnRequest = true;
        this.subject = new BehaviorSubject([]);
        this.http = injector.get(HttpClient);
        this.eventsService = injector.get(GlobalEventsService);
        this.spinner = new NullSpinner();
    }
    ObservableCurdService.prototype.handleError = function (error) {
        this.eventsService.broadcast('http-error', [error]);
    };
    ObservableCurdService.prototype.onDataChange = function () {
        return this.subject.asObservable();
    };
    // Default methods
    ObservableCurdService.prototype.parseCreateResponse = function (record, data) {
        var id = data;
        record.id = id;
        return record;
    };
    ObservableCurdService.prototype.parseUpdateResponse = function (record, data) {
        return record;
    };
    ObservableCurdService.prototype.parseListResponse = function (data) {
        return data;
    };
    // Returns a list of entities
    ObservableCurdService.prototype.listRequest = function (options) {
        var httpParams = new HttpParams();
        for (var k in options) {
            if (options.hasOwnProperty(k)) {
                httpParams = httpParams.set(k, options[k]);
            }
        }
        return this.http.get(this.listUrl(), {
            withCredentials: this.withCredentialOnRequest,
            params: httpParams
        });
    };
    ObservableCurdService.prototype.getListAsync = function (options, mySpinner) {
        var _this = this;
        if (mySpinner === void 0) { mySpinner = null; }
        // In most cases, we do not need to send out a request
        // if we already have some data.
        if (this.getListGuard()) {
            return liftIntoReject('not allowed');
        }
        var spinner = mySpinner || this.spinner;
        spinner.show();
        return toPromise(this.listRequest(options))
            .then(function (data) {
            spinner.hide();
            var newData = _this.parseListResponse(data);
            _this.notifyList(newData);
            return newData;
        }, function (error) {
            spinner.hide();
            _this.handleError(error);
            return error;
        });
    };
    // Use post instead of delete method to implement delelete ??
    ObservableCurdService.prototype.deleteByIdRequest = function (id) {
        return this.http.delete(this.deleteUrl(id), {
            withCredentials: this.withCredentialOnRequest
        });
    };
    ObservableCurdService.prototype.deleteByIdAsync = function (id, mySpinner) {
        var _this = this;
        if (mySpinner === void 0) { mySpinner = null; }
        if (this.deleteByIdGuard(id)) {
            return liftIntoReject('not allowed');
        }
        var spinner = mySpinner || this.spinner;
        spinner.show();
        return toPromise(this.deleteByIdRequest(id))
            .then(function (x) {
            spinner.hide();
            _this.notifyDelete(id);
            return id;
        }, function (error) {
            spinner.hide();
            _this.handleError(error);
            return error;
        });
    };
    ObservableCurdService.prototype.adaptorCreateInput = function (record) {
        return record;
    };
    ObservableCurdService.prototype.createRequest = function (record) {
        var body = {};
        var tyRecord = this.adaptorCreateInput(record);
        for (var prop in tyRecord) {
            if (tyRecord.hasOwnProperty(prop)) {
                body[prop] = tyRecord[prop];
            }
        }
        return this.http.post(this.createUrl(), body, {
            withCredentials: this.withCredentialOnRequest
        });
    };
    ObservableCurdService.prototype.createAsync = function (record, mySpinner) {
        var _this = this;
        if (mySpinner === void 0) { mySpinner = null; }
        var spinner = mySpinner || this.spinner;
        spinner.show();
        return toPromise(this.createRequest(record))
            .then(function (x) {
            spinner.hide();
            // Side effects
            record = _this.parseCreateResponse(record, x);
            _this.notifyCreate(record);
            return record;
        }, function (error) {
            spinner.hide();
            _this.handleError(error);
            return error;
        });
    };
    ObservableCurdService.prototype.adaptorUpdateInput = function (record) {
        return record;
    };
    ObservableCurdService.prototype.updateRequest = function (record) {
        var body = {};
        var tyRecord = this.adaptorUpdateInput(record);
        for (var prop in tyRecord) {
            if (tyRecord.hasOwnProperty(prop)) {
                body[prop] = tyRecord[prop];
            }
        }
        return this.http.put(this.updateUrl(record.id), body, {
            withCredentials: this.withCredentialOnRequest
        });
    };
    ObservableCurdService.prototype.updateAsync = function (record, mySpinner) {
        var _this = this;
        if (mySpinner === void 0) { mySpinner = null; }
        var spinner = mySpinner || this.spinner;
        spinner.show();
        return toPromise(this.updateRequest(record))
            .then(function (x) {
            spinner.hide();
            // Side effects
            record = _this.parseUpdateResponse(record, x);
            _this.notifyUpdate(record);
            return record;
        }, function (error) {
            spinner.hide();
            // TODO: error handling
            _this.handleError(error);
            return error;
        });
    };
    return ObservableCurdService;
}());
export { ObservableCurdService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JzZXJ2YWJsZS1jcnVkLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9scHdhcmUvbmd4LW5ldC1jcnVkLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL29ic2VydmFibGUtY3J1ZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxVQUFVLEVBQTZCLFVBQVUsRUFBcUIsTUFBTSxzQkFBc0IsQ0FBQztBQUU1RyxPQUFPLEVBQWMsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRW5ELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUV4RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFL0MsT0FBTyxFQUNILG1CQUFtQixFQUN0QixNQUFNLHNCQUFzQixDQUFDO0FBRTlCLE9BQU8sRUFFSCxXQUFXLEVBQ2QsTUFBTSx1QkFBdUIsQ0FBQztBQVUvQjtJQVVJLCtCQUFZLFFBQWtCO1FBRTFCLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUM7UUFFcEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUV2QyxJQUFJLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLGFBQWEsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFFdkQsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFxQlMsMkNBQVcsR0FBckIsVUFBc0IsS0FBd0I7UUFDMUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsWUFBWSxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBRU0sNENBQVksR0FBbkI7UUFDSSxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsWUFB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QUFTLEVBQUUsU0FBaUM7UUFBeEQsaUJBcUJDO1FBckJzQiwwQkFBQSxFQUFBLGdCQUFpQztRQUVwRCxJQUFNLE9BQU8sR0FBRyxTQUFTLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUMxQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDZixPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3ZDLElBQUksQ0FBQyxVQUFDLENBQUM7WUFDSixPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFZixlQUFlO1lBQ2YsTUFBTSxHQUFHLEtBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDN0MsS0FBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUUxQixPQUFPLE1BQU0sQ0FBQztRQUNsQixDQUFDLEVBQUUsVUFBQyxLQUFLO1lBQ0wsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1lBRWYsdUJBQXVCO1lBQ3ZCLEtBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7WUFFeEIsT0FBTyxLQUFLLENBQUM7UUFDakIsQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDO0lBRUwsNEJBQUM7QUFBRCxDQUFDLEFBek5ELElBeU5DIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBSZXNwb25zZSwgSHR0cEhlYWRlcnMsIEh0dHBQYXJhbXMsIEh0dHBFcnJvclJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgbGlmdEludG9SZWplY3QgfSBmcm9tICdAcG9scHdhcmUvZmUtdXRpbGl0aWVzJztcblxuaW1wb3J0IHsgdG9Qcm9taXNlIH0gZnJvbSAnQHBvbHB3YXJlL25neC1yeGpzJztcblxuaW1wb3J0IHtcbiAgICBHbG9iYWxFdmVudHNTZXJ2aWNlXG59IGZyb20gJ0Bwb2xwd2FyZS9uZ3gtZXZlbnRzJztcblxuaW1wb3J0IHtcbiAgICBJU3Bpbm5lclNlcnZpY2UsXG4gICAgTnVsbFNwaW5uZXJcbn0gZnJvbSAnQHBvbHB3YXJlL25neC1zcGlubmVyJztcblxuaW1wb3J0IHtcbiAgICBJQmFzZUVudGl0eVxufSBmcm9tICdAcG9scHdhcmUvbmd4LW1vZGVsJztcblxuZXhwb3J0IHtcbiAgICBJQmFzZUVudGl0eVxufSBmcm9tICdAcG9scHdhcmUvbmd4LW1vZGVsJztcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIE9ic2VydmFibGVDdXJkU2VydmljZTxUIGV4dGVuZHMgSUJhc2VFbnRpdHk+IHtcblxuICAgIHByb3RlY3RlZCBzdWJqZWN0OiBCZWhhdmlvclN1YmplY3Q8QXJyYXk8VD4+O1xuXG4gICAgcHJvdGVjdGVkIGh0dHA6IEh0dHBDbGllbnQ7XG4gICAgcHJvdGVjdGVkIGV2ZW50c1NlcnZpY2U6IEdsb2JhbEV2ZW50c1NlcnZpY2U7XG4gICAgcHJvdGVjdGVkIHNwaW5uZXI6IElTcGlubmVyU2VydmljZTtcblxuICAgIHByb3RlY3RlZCB3aXRoQ3JlZGVudGlhbE9uUmVxdWVzdDogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKGluamVjdG9yOiBJbmplY3Rvcikge1xuXG4gICAgICAgIHRoaXMud2l0aENyZWRlbnRpYWxPblJlcXVlc3QgPSB0cnVlO1xuXG4gICAgICAgIHRoaXMuc3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xuXG4gICAgICAgIHRoaXMuaHR0cCA9IGluamVjdG9yLmdldChIdHRwQ2xpZW50KTtcbiAgICAgICAgdGhpcy5ldmVudHNTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KEdsb2JhbEV2ZW50c1NlcnZpY2UpO1xuXG4gICAgICAgIHRoaXMuc3Bpbm5lciA9IG5ldyBOdWxsU3Bpbm5lcigpO1xuICAgIH1cblxuICAgIC8vICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiAgICAvLyBhYnN0cmFjdCBtZXRob2RzXG4gICAgLy8gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBsaXN0VXJsKC4uLmFyZ3M6IGFueVtdKTogc3RyaW5nO1xuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBkZWxldGVVcmwoLi4uYXJnczogYW55W10pOiBzdHJpbmc7XG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IGNyZWF0ZVVybCguLi5hcmdzOiBhbnlbXSk6IHN0cmluZztcbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgdXBkYXRlVXJsKC4uLmFyZ3M6IGFueVtdKTogc3RyaW5nO1xuXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IGdldExpc3RHdWFyZCgpOiBib29sZWFuO1xuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBkZWxldGVCeUlkR3VhcmQoaWQ6IHN0cmluZyk6IGJvb2xlYW47XG5cbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3Qgbm90aWZ5TGlzdChkYXRhOiBBcnJheTxUPik6IHZvaWQ7XG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IG5vdGlmeURlbGV0ZShpZDogc3RyaW5nKTogdm9pZDtcbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3Qgbm90aWZ5Q3JlYXRlKHJlY29yZDogVCk7XG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IG5vdGlmeVVwZGF0ZShyZWNvcmQ6IFQpO1xuXG4gICAgYWJzdHJhY3QgZ2V0QnlJZChpZDogc3RyaW5nKTogVDtcbiAgICBhYnN0cmFjdCBnZXRCeUlkQXN5bmMoaWQ6IHN0cmluZywgbXlTcGlubmVyOiBJU3Bpbm5lclNlcnZpY2UpOiBQcm9taXNlTGlrZTxUPjtcblxuICAgIHByb3RlY3RlZCBoYW5kbGVFcnJvcihlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpIHtcbiAgICAgICAgdGhpcy5ldmVudHNTZXJ2aWNlLmJyb2FkY2FzdCgnaHR0cC1lcnJvcicsIFtlcnJvcl0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBvbkRhdGFDaGFuZ2UoKTogT2JzZXJ2YWJsZTxBcnJheTxUPj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIC8vIERlZmF1bHQgbWV0aG9kc1xuICAgIHByb3RlY3RlZCBwYXJzZUNyZWF0ZVJlc3BvbnNlKHJlY29yZDogVCwgZGF0YSk6IFQge1xuICAgICAgICBjb25zdCBpZCA9IGRhdGE7XG4gICAgICAgIHJlY29yZC5pZCA9IGlkO1xuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBwYXJzZVVwZGF0ZVJlc3BvbnNlKHJlY29yZDogVCwgZGF0YSk6IFQge1xuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBwYXJzZUxpc3RSZXNwb25zZShkYXRhKTogVFtdIHtcbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuXG4gICAgLy8gUmV0dXJucyBhIGxpc3Qgb2YgZW50aXRpZXNcbiAgICBwcm90ZWN0ZWQgbGlzdFJlcXVlc3Qob3B0aW9uczogeyBba2V5OiBzdHJpbmddOiBhbnkgfSk6IE9ic2VydmFibGU8VFtdPiB7XG4gICAgICAgIGxldCBodHRwUGFyYW1zID0gbmV3IEh0dHBQYXJhbXMoKTtcbiAgICAgICAgZm9yIChjb25zdCBrIGluIG9wdGlvbnMpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KGspKSB7XG4gICAgICAgICAgICAgICAgaHR0cFBhcmFtcyA9IGh0dHBQYXJhbXMuc2V0KGssIG9wdGlvbnNba10pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQ8VFtdPih0aGlzLmxpc3RVcmwoKSwge1xuICAgICAgICAgICAgd2l0aENyZWRlbnRpYWxzOiB0aGlzLndpdGhDcmVkZW50aWFsT25SZXF1ZXN0LFxuICAgICAgICAgICAgcGFyYW1zOiBodHRwUGFyYW1zXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldExpc3RBc3luYyhvcHRpb25zOiB7IFtrZXk6IHN0cmluZ106IGFueSB9LCBteVNwaW5uZXI6IElTcGlubmVyU2VydmljZSA9IG51bGwpOiBQcm9taXNlTGlrZTxhbnk+IHtcbiAgICAgICAgLy8gSW4gbW9zdCBjYXNlcywgd2UgZG8gbm90IG5lZWQgdG8gc2VuZCBvdXQgYSByZXF1ZXN0XG4gICAgICAgIC8vIGlmIHdlIGFscmVhZHkgaGF2ZSBzb21lIGRhdGEuXG4gICAgICAgIGlmICh0aGlzLmdldExpc3RHdWFyZCgpKSB7XG4gICAgICAgICAgICByZXR1cm4gbGlmdEludG9SZWplY3QoJ25vdCBhbGxvd2VkJyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzcGlubmVyID0gbXlTcGlubmVyIHx8IHRoaXMuc3Bpbm5lcjtcblxuICAgICAgICBzcGlubmVyLnNob3coKTtcbiAgICAgICAgcmV0dXJuIHRvUHJvbWlzZSh0aGlzLmxpc3RSZXF1ZXN0KG9wdGlvbnMpKVxuICAgICAgICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBzcGlubmVyLmhpZGUoKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IG5ld0RhdGEgPSB0aGlzLnBhcnNlTGlzdFJlc3BvbnNlKGRhdGEpO1xuICAgICAgICAgICAgICAgIHRoaXMubm90aWZ5TGlzdChuZXdEYXRhKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBuZXdEYXRhO1xuICAgICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgc3Bpbm5lci5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBlcnJvcjtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFVzZSBwb3N0IGluc3RlYWQgb2YgZGVsZXRlIG1ldGhvZCB0byBpbXBsZW1lbnQgZGVsZWxldGUgPz9cbiAgICBwcm90ZWN0ZWQgZGVsZXRlQnlJZFJlcXVlc3QoaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5kZWxldGUodGhpcy5kZWxldGVVcmwoaWQpLCB7XG4gICAgICAgICAgICB3aXRoQ3JlZGVudGlhbHM6IHRoaXMud2l0aENyZWRlbnRpYWxPblJlcXVlc3RcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZGVsZXRlQnlJZEFzeW5jKGlkOiBzdHJpbmcsIG15U3Bpbm5lcjogSVNwaW5uZXJTZXJ2aWNlID0gbnVsbCk6IFByb21pc2VMaWtlPGFueT4ge1xuXG4gICAgICAgIGlmICh0aGlzLmRlbGV0ZUJ5SWRHdWFyZChpZCkpIHtcbiAgICAgICAgICAgIHJldHVybiBsaWZ0SW50b1JlamVjdCgnbm90IGFsbG93ZWQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNwaW5uZXIgPSBteVNwaW5uZXIgfHwgdGhpcy5zcGlubmVyO1xuICAgICAgICBzcGlubmVyLnNob3coKTtcbiAgICAgICAgcmV0dXJuIHRvUHJvbWlzZSh0aGlzLmRlbGV0ZUJ5SWRSZXF1ZXN0KGlkKSlcbiAgICAgICAgICAgIC50aGVuKCh4KSA9PiB7XG4gICAgICAgICAgICAgICAgc3Bpbm5lci5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeURlbGV0ZShpZCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGlkO1xuICAgICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgc3Bpbm5lci5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBlcnJvcjtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgcHJvdGVjdGVkIGFkYXB0b3JDcmVhdGVJbnB1dChyZWNvcmQ6IFQpOiBPYmplY3Qge1xuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBjcmVhdGVSZXF1ZXN0KHJlY29yZDogVCk6IE9ic2VydmFibGU8VD4ge1xuICAgICAgICBjb25zdCBib2R5ID0ge307XG4gICAgICAgIGNvbnN0IHR5UmVjb3JkID0gdGhpcy5hZGFwdG9yQ3JlYXRlSW5wdXQocmVjb3JkKTtcbiAgICAgICAgZm9yIChjb25zdCBwcm9wIGluIHR5UmVjb3JkKSB7XG4gICAgICAgICAgICBpZiAodHlSZWNvcmQuaGFzT3duUHJvcGVydHkocHJvcCkpIHtcbiAgICAgICAgICAgICAgICBib2R5W3Byb3BdID0gdHlSZWNvcmRbcHJvcF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0PFQ+KHRoaXMuY3JlYXRlVXJsKCksIGJvZHksIHtcbiAgICAgICAgICAgIHdpdGhDcmVkZW50aWFsczogdGhpcy53aXRoQ3JlZGVudGlhbE9uUmVxdWVzdFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjcmVhdGVBc3luYyhyZWNvcmQ6IFQsIG15U3Bpbm5lcjogSVNwaW5uZXJTZXJ2aWNlID0gbnVsbCk6IFByb21pc2VMaWtlPGFueT4ge1xuXG4gICAgICAgIGNvbnN0IHNwaW5uZXIgPSBteVNwaW5uZXIgfHwgdGhpcy5zcGlubmVyO1xuICAgICAgICBzcGlubmVyLnNob3coKTtcbiAgICAgICAgcmV0dXJuIHRvUHJvbWlzZSh0aGlzLmNyZWF0ZVJlcXVlc3QocmVjb3JkKSlcbiAgICAgICAgICAgIC50aGVuKCh4KSA9PiB7XG4gICAgICAgICAgICAgICAgc3Bpbm5lci5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICAvLyBTaWRlIGVmZmVjdHNcbiAgICAgICAgICAgICAgICByZWNvcmQgPSB0aGlzLnBhcnNlQ3JlYXRlUmVzcG9uc2UocmVjb3JkLCB4KTtcbiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeUNyZWF0ZShyZWNvcmQpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHNwaW5uZXIuaGlkZSgpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVFcnJvcihlcnJvcik7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZXJyb3I7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYWRhcHRvclVwZGF0ZUlucHV0KHJlY29yZDogVCk6IE9iamVjdCB7XG4gICAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHVwZGF0ZVJlcXVlc3QocmVjb3JkOiBUKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgICAgIGNvbnN0IGJvZHkgPSB7fTtcbiAgICAgICAgY29uc3QgdHlSZWNvcmQgPSB0aGlzLmFkYXB0b3JVcGRhdGVJbnB1dChyZWNvcmQpO1xuICAgICAgICBmb3IgKGNvbnN0IHByb3AgaW4gdHlSZWNvcmQpIHtcbiAgICAgICAgICAgIGlmICh0eVJlY29yZC5oYXNPd25Qcm9wZXJ0eShwcm9wKSkge1xuICAgICAgICAgICAgICAgIGJvZHlbcHJvcF0gPSB0eVJlY29yZFtwcm9wXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAucHV0PFQ+KHRoaXMudXBkYXRlVXJsKHJlY29yZC5pZCksIGJvZHksIHtcbiAgICAgICAgICAgIHdpdGhDcmVkZW50aWFsczogdGhpcy53aXRoQ3JlZGVudGlhbE9uUmVxdWVzdFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICB1cGRhdGVBc3luYyhyZWNvcmQ6IFQsIG15U3Bpbm5lcjogSVNwaW5uZXJTZXJ2aWNlID0gbnVsbCk6IFByb21pc2VMaWtlPGFueT4ge1xuXG4gICAgICAgIGNvbnN0IHNwaW5uZXIgPSBteVNwaW5uZXIgfHwgdGhpcy5zcGlubmVyO1xuICAgICAgICBzcGlubmVyLnNob3coKTtcbiAgICAgICAgcmV0dXJuIHRvUHJvbWlzZSh0aGlzLnVwZGF0ZVJlcXVlc3QocmVjb3JkKSlcbiAgICAgICAgICAgIC50aGVuKCh4KSA9PiB7XG4gICAgICAgICAgICAgICAgc3Bpbm5lci5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICAvLyBTaWRlIGVmZmVjdHNcbiAgICAgICAgICAgICAgICByZWNvcmQgPSB0aGlzLnBhcnNlVXBkYXRlUmVzcG9uc2UocmVjb3JkLCB4KTtcbiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeVVwZGF0ZShyZWNvcmQpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHNwaW5uZXIuaGlkZSgpO1xuXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogZXJyb3IgaGFuZGxpbmdcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBlcnJvcjtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxufVxuIl19