import { HttpClient, HttpParams } from '@angular/common/http';
import { BehaviorSubject } from 'rxjs';
import { liftIntoReject } from '@polpware/fe-utilities';
import { toPromise } from '@polpware/ngx-rxjs';
import { GlobalEventsService } from '@polpware/ngx-events';
import { NullSpinner } from '@polpware/ngx-spinner';
export class ObservableCurdService {
    constructor(injector) {
        this.withCredentialOnRequest = true;
        this.subject = new BehaviorSubject([]);
        this.http = injector.get(HttpClient);
        this.eventsService = injector.get(GlobalEventsService);
        this.spinner = new NullSpinner();
    }
    handleError(error) {
        this.eventsService.broadcast('http-error', [error]);
    }
    onDataChange() {
        return this.subject.asObservable();
    }
    // Default methods
    parseCreateResponse(record, data) {
        const id = data;
        record.id = id;
        return record;
    }
    parseUpdateResponse(record, data) {
        return record;
    }
    parseListResponse(data) {
        return data;
    }
    // Returns a list of entities
    listRequest(options) {
        let httpParams = new HttpParams();
        for (const k in options) {
            if (options.hasOwnProperty(k)) {
                httpParams = httpParams.set(k, options[k]);
            }
        }
        return this.http.get(this.listUrl(), {
            withCredentials: this.withCredentialOnRequest,
            params: httpParams
        });
    }
    getListAsync(options, mySpinner = null) {
        // In most cases, we do not need to send out a request
        // if we already have some data.
        if (this.getListGuard()) {
            return liftIntoReject('not allowed');
        }
        const spinner = mySpinner || this.spinner;
        spinner.show();
        return toPromise(this.listRequest(options))
            .then((data) => {
            spinner.hide();
            const newData = this.parseListResponse(data);
            this.notifyList(newData);
            return newData;
        }, (error) => {
            spinner.hide();
            this.handleError(error);
            return error;
        });
    }
    // Use post instead of delete method to implement delelete ??
    deleteByIdRequest(id) {
        return this.http.delete(this.deleteUrl(id), {
            withCredentials: this.withCredentialOnRequest
        });
    }
    deleteByIdAsync(id, mySpinner = null) {
        if (this.deleteByIdGuard(id)) {
            return liftIntoReject('not allowed');
        }
        const spinner = mySpinner || this.spinner;
        spinner.show();
        return toPromise(this.deleteByIdRequest(id))
            .then((x) => {
            spinner.hide();
            this.notifyDelete(id);
            return id;
        }, (error) => {
            spinner.hide();
            this.handleError(error);
            return error;
        });
    }
    adaptorCreateInput(record) {
        return record;
    }
    createRequest(record) {
        const body = {};
        const tyRecord = this.adaptorCreateInput(record);
        for (const prop in tyRecord) {
            if (tyRecord.hasOwnProperty(prop)) {
                body[prop] = tyRecord[prop];
            }
        }
        return this.http.post(this.createUrl(), body, {
            withCredentials: this.withCredentialOnRequest
        });
    }
    createAsync(record, mySpinner = null) {
        const spinner = mySpinner || this.spinner;
        spinner.show();
        return toPromise(this.createRequest(record))
            .then((x) => {
            spinner.hide();
            // Side effects
            record = this.parseCreateResponse(record, x);
            this.notifyCreate(record);
            return record;
        }, (error) => {
            spinner.hide();
            this.handleError(error);
            return error;
        });
    }
    adaptorUpdateInput(record) {
        return record;
    }
    updateRequest(record) {
        const body = {};
        const tyRecord = this.adaptorUpdateInput(record);
        for (const prop in tyRecord) {
            if (tyRecord.hasOwnProperty(prop)) {
                body[prop] = tyRecord[prop];
            }
        }
        return this.http.put(this.updateUrl(record.id), body, {
            withCredentials: this.withCredentialOnRequest
        });
    }
    updateAsync(record, mySpinner = null) {
        const spinner = mySpinner || this.spinner;
        spinner.show();
        return toPromise(this.updateRequest(record))
            .then((x) => {
            spinner.hide();
            // Side effects
            record = this.parseUpdateResponse(record, x);
            this.notifyUpdate(record);
            return record;
        }, (error) => {
            spinner.hide();
            // TODO: error handling
            this.handleError(error);
            return error;
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2JzZXJ2YWJsZS1jcnVkLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG9scHdhcmUvbmd4LW5ldC1jcnVkLyIsInNvdXJjZXMiOlsibGliL3NlcnZpY2VzL29ic2VydmFibGUtY3J1ZC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxVQUFVLEVBQTZCLFVBQVUsRUFBcUIsTUFBTSxzQkFBc0IsQ0FBQztBQUU1RyxPQUFPLEVBQWMsZUFBZSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRW5ELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUV4RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFFL0MsT0FBTyxFQUNILG1CQUFtQixFQUN0QixNQUFNLHNCQUFzQixDQUFDO0FBRTlCLE9BQU8sRUFFSCxXQUFXLEVBQ2QsTUFBTSx1QkFBdUIsQ0FBQztBQVUvQixNQUFNLE9BQWdCLHFCQUFxQjtJQVV2QyxZQUFZLFFBQWtCO1FBRTFCLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUM7UUFFcEMsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLGVBQWUsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUV2QyxJQUFJLENBQUMsSUFBSSxHQUFHLFFBQVEsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLGFBQWEsR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFFdkQsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLFdBQVcsRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFxQlMsV0FBVyxDQUFDLEtBQXdCO1FBQzFDLElBQUksQ0FBQyxhQUFhLENBQUMsU0FBUyxDQUFDLFlBQVksRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVNLFlBQVk7UUFDZixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDdkMsQ0FBQztJQUVELGtCQUFrQjtJQUNSLG1CQUFtQixDQUFDLE1BQVMsRUFBRSxJQUFJO1FBQ3pDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQztRQUNoQixNQUFNLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUNmLE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFFUyxtQkFBbUIsQ0FBQyxNQUFTLEVBQUUsSUFBSTtRQUN6QyxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0lBRVMsaUJBQWlCLENBQUMsSUFBSTtRQUM1QixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUQsNkJBQTZCO0lBQ25CLFdBQVcsQ0FBQyxPQUErQjtRQUNqRCxJQUFJLFVBQVUsR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO1FBQ2xDLEtBQUssTUFBTSxDQUFDLElBQUksT0FBTyxFQUFFO1lBQ3JCLElBQUksT0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUMsRUFBRTtnQkFDM0IsVUFBVSxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQzlDO1NBQ0o7UUFFRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFNLElBQUksQ0FBQyxPQUFPLEVBQUUsRUFBRTtZQUN0QyxlQUFlLEVBQUUsSUFBSSxDQUFDLHVCQUF1QjtZQUM3QyxNQUFNLEVBQUUsVUFBVTtTQUNyQixDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsWUFBWSxDQUFDLE9BQStCLEVBQUUsWUFBNkIsSUFBSTtRQUMzRSxzREFBc0Q7UUFDdEQsZ0NBQWdDO1FBQ2hDLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRSxFQUFFO1lBQ3JCLE9BQU8sY0FBYyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1NBQ3hDO1FBRUQsTUFBTSxPQUFPLEdBQUcsU0FBUyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUM7UUFFMUMsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2YsT0FBTyxTQUFTLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQzthQUN0QyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUNYLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUVmLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM3QyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1lBRXpCLE9BQU8sT0FBTyxDQUFDO1FBQ25CLENBQUMsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFO1lBQ1QsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1lBRWYsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUV4QixPQUFPLEtBQUssQ0FBQztRQUNqQixDQUFDLENBQUMsQ0FBQztJQUNYLENBQUM7SUFFRCw2REFBNkQ7SUFDbkQsaUJBQWlCLENBQUMsRUFBVTtRQUNsQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLEVBQUU7WUFDeEMsZUFBZSxFQUFFLElBQUksQ0FBQyx1QkFBdUI7U0FDaEQsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELGVBQWUsQ0FBQyxFQUFVLEVBQUUsWUFBNkIsSUFBSTtRQUV6RCxJQUFJLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLEVBQUU7WUFDMUIsT0FBTyxjQUFjLENBQUMsYUFBYSxDQUFDLENBQUM7U0FDeEM7UUFFRCxNQUFNLE9BQU8sR0FBRyxTQUFTLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUMxQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDZixPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLENBQUM7YUFDdkMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDUixPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFZixJQUFJLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3RCLE9BQU8sRUFBRSxDQUFDO1FBQ2QsQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDVCxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFZixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXhCLE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUdTLGtCQUFrQixDQUFDLE1BQVM7UUFDbEMsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVTLGFBQWEsQ0FBQyxNQUFTO1FBQzdCLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNoQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDakQsS0FBSyxNQUFNLElBQUksSUFBSSxRQUFRLEVBQUU7WUFDekIsSUFBSSxRQUFRLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUMvQixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQy9CO1NBQ0o7UUFDRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFJLElBQUksQ0FBQyxTQUFTLEVBQUUsRUFBRSxJQUFJLEVBQUU7WUFDN0MsZUFBZSxFQUFFLElBQUksQ0FBQyx1QkFBdUI7U0FDaEQsQ0FBQyxDQUFDO0lBQ1AsQ0FBQztJQUVELFdBQVcsQ0FBQyxNQUFTLEVBQUUsWUFBNkIsSUFBSTtRQUVwRCxNQUFNLE9BQU8sR0FBRyxTQUFTLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQztRQUMxQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDZixPQUFPLFNBQVMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxDQUFDO2FBQ3ZDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO1lBQ1IsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO1lBRWYsZUFBZTtZQUNmLE1BQU0sR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUM7WUFFMUIsT0FBTyxNQUFNLENBQUM7UUFDbEIsQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDVCxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFZixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXhCLE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUVTLGtCQUFrQixDQUFDLE1BQVM7UUFDbEMsT0FBTyxNQUFNLENBQUM7SUFDbEIsQ0FBQztJQUVTLGFBQWEsQ0FBQyxNQUFTO1FBQzdCLE1BQU0sSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNoQixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDakQsS0FBSyxNQUFNLElBQUksSUFBSSxRQUFRLEVBQUU7WUFDekIsSUFBSSxRQUFRLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFO2dCQUMvQixJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2FBQy9CO1NBQ0o7UUFFRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRTtZQUNyRCxlQUFlLEVBQUUsSUFBSSxDQUFDLHVCQUF1QjtTQUNoRCxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsV0FBVyxDQUFDLE1BQVMsRUFBRSxZQUE2QixJQUFJO1FBRXBELE1BQU0sT0FBTyxHQUFHLFNBQVMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDO1FBQzFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNmLE9BQU8sU0FBUyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDdkMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUU7WUFDUixPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7WUFFZixlQUFlO1lBQ2YsTUFBTSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDN0MsSUFBSSxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUUxQixPQUFPLE1BQU0sQ0FBQztRQUNsQixDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUNULE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUVmLHVCQUF1QjtZQUN2QixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRXhCLE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUMsQ0FBQyxDQUFDO0lBQ1gsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBDbGllbnQsIEh0dHBSZXNwb25zZSwgSHR0cEhlYWRlcnMsIEh0dHBQYXJhbXMsIEh0dHBFcnJvclJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBCZWhhdmlvclN1YmplY3QgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgbGlmdEludG9SZWplY3QgfSBmcm9tICdAcG9scHdhcmUvZmUtdXRpbGl0aWVzJztcblxuaW1wb3J0IHsgdG9Qcm9taXNlIH0gZnJvbSAnQHBvbHB3YXJlL25neC1yeGpzJztcblxuaW1wb3J0IHtcbiAgICBHbG9iYWxFdmVudHNTZXJ2aWNlXG59IGZyb20gJ0Bwb2xwd2FyZS9uZ3gtZXZlbnRzJztcblxuaW1wb3J0IHtcbiAgICBJU3Bpbm5lclNlcnZpY2UsXG4gICAgTnVsbFNwaW5uZXJcbn0gZnJvbSAnQHBvbHB3YXJlL25neC1zcGlubmVyJztcblxuaW1wb3J0IHtcbiAgICBJQmFzZUVudGl0eVxufSBmcm9tICdAcG9scHdhcmUvbmd4LW1vZGVsJztcblxuZXhwb3J0IHtcbiAgICBJQmFzZUVudGl0eVxufSBmcm9tICdAcG9scHdhcmUvbmd4LW1vZGVsJztcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIE9ic2VydmFibGVDdXJkU2VydmljZTxUIGV4dGVuZHMgSUJhc2VFbnRpdHk+IHtcblxuICAgIHByb3RlY3RlZCBzdWJqZWN0OiBCZWhhdmlvclN1YmplY3Q8QXJyYXk8VD4+O1xuXG4gICAgcHJvdGVjdGVkIGh0dHA6IEh0dHBDbGllbnQ7XG4gICAgcHJvdGVjdGVkIGV2ZW50c1NlcnZpY2U6IEdsb2JhbEV2ZW50c1NlcnZpY2U7XG4gICAgcHJvdGVjdGVkIHNwaW5uZXI6IElTcGlubmVyU2VydmljZTtcblxuICAgIHByb3RlY3RlZCB3aXRoQ3JlZGVudGlhbE9uUmVxdWVzdDogYm9vbGVhbjtcblxuICAgIGNvbnN0cnVjdG9yKGluamVjdG9yOiBJbmplY3Rvcikge1xuXG4gICAgICAgIHRoaXMud2l0aENyZWRlbnRpYWxPblJlcXVlc3QgPSB0cnVlO1xuXG4gICAgICAgIHRoaXMuc3ViamVjdCA9IG5ldyBCZWhhdmlvclN1YmplY3QoW10pO1xuXG4gICAgICAgIHRoaXMuaHR0cCA9IGluamVjdG9yLmdldChIdHRwQ2xpZW50KTtcbiAgICAgICAgdGhpcy5ldmVudHNTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KEdsb2JhbEV2ZW50c1NlcnZpY2UpO1xuXG4gICAgICAgIHRoaXMuc3Bpbm5lciA9IG5ldyBOdWxsU3Bpbm5lcigpO1xuICAgIH1cblxuICAgIC8vICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiAgICAvLyBhYnN0cmFjdCBtZXRob2RzXG4gICAgLy8gKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBsaXN0VXJsKC4uLmFyZ3M6IGFueVtdKTogc3RyaW5nO1xuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBkZWxldGVVcmwoLi4uYXJnczogYW55W10pOiBzdHJpbmc7XG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IGNyZWF0ZVVybCguLi5hcmdzOiBhbnlbXSk6IHN0cmluZztcbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3QgdXBkYXRlVXJsKC4uLmFyZ3M6IGFueVtdKTogc3RyaW5nO1xuXG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IGdldExpc3RHdWFyZCgpOiBib29sZWFuO1xuICAgIHByb3RlY3RlZCBhYnN0cmFjdCBkZWxldGVCeUlkR3VhcmQoaWQ6IHN0cmluZyk6IGJvb2xlYW47XG5cbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3Qgbm90aWZ5TGlzdChkYXRhOiBBcnJheTxUPik6IHZvaWQ7XG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IG5vdGlmeURlbGV0ZShpZDogc3RyaW5nKTogdm9pZDtcbiAgICBwcm90ZWN0ZWQgYWJzdHJhY3Qgbm90aWZ5Q3JlYXRlKHJlY29yZDogVCk7XG4gICAgcHJvdGVjdGVkIGFic3RyYWN0IG5vdGlmeVVwZGF0ZShyZWNvcmQ6IFQpO1xuXG4gICAgYWJzdHJhY3QgZ2V0QnlJZChpZDogc3RyaW5nKTogVDtcbiAgICBhYnN0cmFjdCBnZXRCeUlkQXN5bmMoaWQ6IHN0cmluZywgbXlTcGlubmVyOiBJU3Bpbm5lclNlcnZpY2UpOiBQcm9taXNlTGlrZTxUPjtcblxuICAgIHByb3RlY3RlZCBoYW5kbGVFcnJvcihlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpIHtcbiAgICAgICAgdGhpcy5ldmVudHNTZXJ2aWNlLmJyb2FkY2FzdCgnaHR0cC1lcnJvcicsIFtlcnJvcl0pO1xuICAgIH1cblxuICAgIHB1YmxpYyBvbkRhdGFDaGFuZ2UoKTogT2JzZXJ2YWJsZTxBcnJheTxUPj4ge1xuICAgICAgICByZXR1cm4gdGhpcy5zdWJqZWN0LmFzT2JzZXJ2YWJsZSgpO1xuICAgIH1cblxuICAgIC8vIERlZmF1bHQgbWV0aG9kc1xuICAgIHByb3RlY3RlZCBwYXJzZUNyZWF0ZVJlc3BvbnNlKHJlY29yZDogVCwgZGF0YSk6IFQge1xuICAgICAgICBjb25zdCBpZCA9IGRhdGE7XG4gICAgICAgIHJlY29yZC5pZCA9IGlkO1xuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBwYXJzZVVwZGF0ZVJlc3BvbnNlKHJlY29yZDogVCwgZGF0YSk6IFQge1xuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBwYXJzZUxpc3RSZXNwb25zZShkYXRhKTogVFtdIHtcbiAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuXG4gICAgLy8gUmV0dXJucyBhIGxpc3Qgb2YgZW50aXRpZXNcbiAgICBwcm90ZWN0ZWQgbGlzdFJlcXVlc3Qob3B0aW9uczogeyBba2V5OiBzdHJpbmddOiBhbnkgfSk6IE9ic2VydmFibGU8VFtdPiB7XG4gICAgICAgIGxldCBodHRwUGFyYW1zID0gbmV3IEh0dHBQYXJhbXMoKTtcbiAgICAgICAgZm9yIChjb25zdCBrIGluIG9wdGlvbnMpIHtcbiAgICAgICAgICAgIGlmIChvcHRpb25zLmhhc093blByb3BlcnR5KGspKSB7XG4gICAgICAgICAgICAgICAgaHR0cFBhcmFtcyA9IGh0dHBQYXJhbXMuc2V0KGssIG9wdGlvbnNba10pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQ8VFtdPih0aGlzLmxpc3RVcmwoKSwge1xuICAgICAgICAgICAgd2l0aENyZWRlbnRpYWxzOiB0aGlzLndpdGhDcmVkZW50aWFsT25SZXF1ZXN0LFxuICAgICAgICAgICAgcGFyYW1zOiBodHRwUGFyYW1zXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldExpc3RBc3luYyhvcHRpb25zOiB7IFtrZXk6IHN0cmluZ106IGFueSB9LCBteVNwaW5uZXI6IElTcGlubmVyU2VydmljZSA9IG51bGwpOiBQcm9taXNlTGlrZTxhbnk+IHtcbiAgICAgICAgLy8gSW4gbW9zdCBjYXNlcywgd2UgZG8gbm90IG5lZWQgdG8gc2VuZCBvdXQgYSByZXF1ZXN0XG4gICAgICAgIC8vIGlmIHdlIGFscmVhZHkgaGF2ZSBzb21lIGRhdGEuXG4gICAgICAgIGlmICh0aGlzLmdldExpc3RHdWFyZCgpKSB7XG4gICAgICAgICAgICByZXR1cm4gbGlmdEludG9SZWplY3QoJ25vdCBhbGxvd2VkJyk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBzcGlubmVyID0gbXlTcGlubmVyIHx8IHRoaXMuc3Bpbm5lcjtcblxuICAgICAgICBzcGlubmVyLnNob3coKTtcbiAgICAgICAgcmV0dXJuIHRvUHJvbWlzZSh0aGlzLmxpc3RSZXF1ZXN0KG9wdGlvbnMpKVxuICAgICAgICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICBzcGlubmVyLmhpZGUoKTtcblxuICAgICAgICAgICAgICAgIGNvbnN0IG5ld0RhdGEgPSB0aGlzLnBhcnNlTGlzdFJlc3BvbnNlKGRhdGEpO1xuICAgICAgICAgICAgICAgIHRoaXMubm90aWZ5TGlzdChuZXdEYXRhKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBuZXdEYXRhO1xuICAgICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgc3Bpbm5lci5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBlcnJvcjtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8vIFVzZSBwb3N0IGluc3RlYWQgb2YgZGVsZXRlIG1ldGhvZCB0byBpbXBsZW1lbnQgZGVsZWxldGUgPz9cbiAgICBwcm90ZWN0ZWQgZGVsZXRlQnlJZFJlcXVlc3QoaWQ6IHN0cmluZyk6IE9ic2VydmFibGU8e30+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5kZWxldGUodGhpcy5kZWxldGVVcmwoaWQpLCB7XG4gICAgICAgICAgICB3aXRoQ3JlZGVudGlhbHM6IHRoaXMud2l0aENyZWRlbnRpYWxPblJlcXVlc3RcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZGVsZXRlQnlJZEFzeW5jKGlkOiBzdHJpbmcsIG15U3Bpbm5lcjogSVNwaW5uZXJTZXJ2aWNlID0gbnVsbCk6IFByb21pc2VMaWtlPGFueT4ge1xuXG4gICAgICAgIGlmICh0aGlzLmRlbGV0ZUJ5SWRHdWFyZChpZCkpIHtcbiAgICAgICAgICAgIHJldHVybiBsaWZ0SW50b1JlamVjdCgnbm90IGFsbG93ZWQnKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IHNwaW5uZXIgPSBteVNwaW5uZXIgfHwgdGhpcy5zcGlubmVyO1xuICAgICAgICBzcGlubmVyLnNob3coKTtcbiAgICAgICAgcmV0dXJuIHRvUHJvbWlzZSh0aGlzLmRlbGV0ZUJ5SWRSZXF1ZXN0KGlkKSlcbiAgICAgICAgICAgIC50aGVuKCh4KSA9PiB7XG4gICAgICAgICAgICAgICAgc3Bpbm5lci5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeURlbGV0ZShpZCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGlkO1xuICAgICAgICAgICAgfSwgKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgc3Bpbm5lci5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBlcnJvcjtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuXG4gICAgcHJvdGVjdGVkIGFkYXB0b3JDcmVhdGVJbnB1dChyZWNvcmQ6IFQpOiBPYmplY3Qge1xuICAgICAgICByZXR1cm4gcmVjb3JkO1xuICAgIH1cblxuICAgIHByb3RlY3RlZCBjcmVhdGVSZXF1ZXN0KHJlY29yZDogVCk6IE9ic2VydmFibGU8VD4ge1xuICAgICAgICBjb25zdCBib2R5ID0ge307XG4gICAgICAgIGNvbnN0IHR5UmVjb3JkID0gdGhpcy5hZGFwdG9yQ3JlYXRlSW5wdXQocmVjb3JkKTtcbiAgICAgICAgZm9yIChjb25zdCBwcm9wIGluIHR5UmVjb3JkKSB7XG4gICAgICAgICAgICBpZiAodHlSZWNvcmQuaGFzT3duUHJvcGVydHkocHJvcCkpIHtcbiAgICAgICAgICAgICAgICBib2R5W3Byb3BdID0gdHlSZWNvcmRbcHJvcF07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5wb3N0PFQ+KHRoaXMuY3JlYXRlVXJsKCksIGJvZHksIHtcbiAgICAgICAgICAgIHdpdGhDcmVkZW50aWFsczogdGhpcy53aXRoQ3JlZGVudGlhbE9uUmVxdWVzdFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBjcmVhdGVBc3luYyhyZWNvcmQ6IFQsIG15U3Bpbm5lcjogSVNwaW5uZXJTZXJ2aWNlID0gbnVsbCk6IFByb21pc2VMaWtlPGFueT4ge1xuXG4gICAgICAgIGNvbnN0IHNwaW5uZXIgPSBteVNwaW5uZXIgfHwgdGhpcy5zcGlubmVyO1xuICAgICAgICBzcGlubmVyLnNob3coKTtcbiAgICAgICAgcmV0dXJuIHRvUHJvbWlzZSh0aGlzLmNyZWF0ZVJlcXVlc3QocmVjb3JkKSlcbiAgICAgICAgICAgIC50aGVuKCh4KSA9PiB7XG4gICAgICAgICAgICAgICAgc3Bpbm5lci5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICAvLyBTaWRlIGVmZmVjdHNcbiAgICAgICAgICAgICAgICByZWNvcmQgPSB0aGlzLnBhcnNlQ3JlYXRlUmVzcG9uc2UocmVjb3JkLCB4KTtcbiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeUNyZWF0ZShyZWNvcmQpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHNwaW5uZXIuaGlkZSgpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVFcnJvcihlcnJvcik7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gZXJyb3I7XG4gICAgICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgYWRhcHRvclVwZGF0ZUlucHV0KHJlY29yZDogVCk6IE9iamVjdCB7XG4gICAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHVwZGF0ZVJlcXVlc3QocmVjb3JkOiBUKTogT2JzZXJ2YWJsZTxUPiB7XG4gICAgICAgIGNvbnN0IGJvZHkgPSB7fTtcbiAgICAgICAgY29uc3QgdHlSZWNvcmQgPSB0aGlzLmFkYXB0b3JVcGRhdGVJbnB1dChyZWNvcmQpO1xuICAgICAgICBmb3IgKGNvbnN0IHByb3AgaW4gdHlSZWNvcmQpIHtcbiAgICAgICAgICAgIGlmICh0eVJlY29yZC5oYXNPd25Qcm9wZXJ0eShwcm9wKSkge1xuICAgICAgICAgICAgICAgIGJvZHlbcHJvcF0gPSB0eVJlY29yZFtwcm9wXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAucHV0PFQ+KHRoaXMudXBkYXRlVXJsKHJlY29yZC5pZCksIGJvZHksIHtcbiAgICAgICAgICAgIHdpdGhDcmVkZW50aWFsczogdGhpcy53aXRoQ3JlZGVudGlhbE9uUmVxdWVzdFxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICB1cGRhdGVBc3luYyhyZWNvcmQ6IFQsIG15U3Bpbm5lcjogSVNwaW5uZXJTZXJ2aWNlID0gbnVsbCk6IFByb21pc2VMaWtlPGFueT4ge1xuXG4gICAgICAgIGNvbnN0IHNwaW5uZXIgPSBteVNwaW5uZXIgfHwgdGhpcy5zcGlubmVyO1xuICAgICAgICBzcGlubmVyLnNob3coKTtcbiAgICAgICAgcmV0dXJuIHRvUHJvbWlzZSh0aGlzLnVwZGF0ZVJlcXVlc3QocmVjb3JkKSlcbiAgICAgICAgICAgIC50aGVuKCh4KSA9PiB7XG4gICAgICAgICAgICAgICAgc3Bpbm5lci5oaWRlKCk7XG5cbiAgICAgICAgICAgICAgICAvLyBTaWRlIGVmZmVjdHNcbiAgICAgICAgICAgICAgICByZWNvcmQgPSB0aGlzLnBhcnNlVXBkYXRlUmVzcG9uc2UocmVjb3JkLCB4KTtcbiAgICAgICAgICAgICAgICB0aGlzLm5vdGlmeVVwZGF0ZShyZWNvcmQpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlY29yZDtcbiAgICAgICAgICAgIH0sIChlcnJvcikgPT4ge1xuICAgICAgICAgICAgICAgIHNwaW5uZXIuaGlkZSgpO1xuXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogZXJyb3IgaGFuZGxpbmdcbiAgICAgICAgICAgICAgICB0aGlzLmhhbmRsZUVycm9yKGVycm9yKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiBlcnJvcjtcbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxufVxuIl19